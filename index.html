<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HomeChain Explorer | Solscan Style</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #121212;
            --bg-card: #1c1c1c;
            --bg-header: #181818;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --accent: #00ffd5;
            --border: #2c2c2c;
            --hover: #2a2a2a;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: 'Roboto', sans-serif;
            margin: 0;
            font-size: 14px;
        }

        .navbar {
            background-color: var(--bg-header);
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            cursor: pointer;
        }

        .search-bar {
            flex: 1;
            max-width: 400px;
            margin: 0 20px;
            position: relative;
        }

        .search-input {
            width: 100%;
            background: #252525;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 16px;
            color: white;
            font-family: inherit;
        }

        .search-input:focus {
            border-color: var(--accent);
            outline: none;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            margin: 0 24px;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
            font-size: 13px;
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--accent);
        }

        .container {
            max-width: 1400px;
            margin: 24px auto;
            padding: 0 24px;
        }

        .market-overview {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
        }

        .card-label {
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .card-value {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .split-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .section-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 16px;
            font-weight: 500;
        }

        .view-all {
            color: var(--accent);
            font-size: 12px;
            text-decoration: none;
            cursor: pointer;
        }

        .table-row {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
        }

        .table-row:hover {
            background: var(--hover);
        }

        .row-icon {
            width: 40px;
            height: 40px;
            background: #2a2a2a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            color: var(--text-secondary);
        }

        .row-data {
            flex: 1;
        }

        .row-primary {
            display: block;
            color: var(--accent);
            margin-bottom: 4px;
            cursor: pointer;
        }

        .row-secondary {
            display: block;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .row-meta {
            text-align: right;
        }

        .badge-pill {
            background: rgba(0, 255, 213, 0.1);
            color: var(--accent);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #252525;
            padding: 8px 24px;
            font-size: 12px;
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }

        th {
            text-align: left;
            padding: 12px;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.02);
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        td .addr {
            font-family: monospace;
            color: var(--accent);
            cursor: pointer;
        }

        td .hash {
            font-family: monospace;
            color: white;
            cursor: pointer;
        }

        td .badge {
            background: rgba(0, 243, 255, 0.1);
            color: var(--accent);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .row-data,
        .row-meta {
            display: flex;
            flex-direction: column;
        }

        /* Keep for mobile/summary */
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="brand" onclick="navigateTo('/')">
            <img src="logo_final.png" alt="HomeChain" style="height: 38px; border-radius: 8px;">
            <span>HomeChainScan</span>
        </div>
        <div class="nav-links">
            <a href="#/" class="nav-link active" data-link id="nav-home">Home</a>
            <a href="#/blocks" class="nav-link" data-link id="nav-blocks">Blocks</a>
            <a href="#/transaction" class="nav-link" data-link id="nav-txs">Transactions</a>
            <a href="#/holder" class="nav-link" data-link id="nav-holders">Holders</a>
            <a href="#/analytics" class="nav-link" data-link id="nav-analytics">Analytics</a>
            <a href="#/validator" class="nav-link" data-link id="nav-validators">Validators</a>
        </div>
        <div class="search-bar">
            <input type="text" id="globalSearch" class="search-input" placeholder="Search by Block, Hash, Address">
        </div>
        <div class="status-indicator">
            <div id="connStatus" class="badge-pill">
                <span>CONNECTING...</span>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Home -->
        <div id="section-home" class="page-section">
            <div class="market-overview">
                <div class="card">
                    <div class="card-label">Block Height</div>
                    <div class="card-value" id="statHeight">---</div>
                </div>
                <div class="card">
                    <div class="card-label">Network Difficulty</div>
                    <div class="card-value" id="statDiff">---</div>
                </div>
                <div class="card">
                    <div class="card-label">Total Supply</div>
                    <div class="card-value" id="statSupply">---</div>
                </div>
                <div class="card">
                    <div class="card-label">Total Holders</div>
                    <div class="card-value" id="statHolders">---</div>
                </div>
            </div>
            <div class="split-view">
                <div class="card" style="padding:0">
                    <div class="section-header">
                        <div class="section-title">Latest Blocks</div><a class="view-all" href="#/blocks" data-link>View
                            All</a>
                    </div>
                    <div id="blocksListSummary"></div>
                </div>
                <div class="card" style="padding:0">
                    <div class="section-header">
                        <div class="section-title">Latest Transactions</div><a class="view-all" href="#/transaction"
                            data-link>View All</a>
                    </div>
                    <div id="txListSummary"></div>
                </div>
            </div>
        </div>

        <!-- Sections -->
        <div id="section-blocks" class="page-section" style="display:none">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h2>Blocks</h2>
                <div id="blocksPagination" class="pagination-controls"></div>
            </div>
            <div class="card" id="blocksListFull"></div>
        </div>
        <div id="section-txs" class="page-section" style="display:none">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h2>Transactions</h2>
                <div id="txsPagination" class="pagination-controls"></div>
            </div>
            <div class="card" id="txListFull"></div>
        </div>
        <div id="section-holders" class="page-section" style="display:none">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h2>Top Holders</h2>
                <div id="holdersPagination" class="pagination-controls"></div>
            </div>
            <div class="card" id="holdersList"></div>
        </div>
        <div id="section-validators" class="page-section" style="display:none">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h2>Validators</h2>
                <div id="validatorsPagination" class="pagination-controls"></div>
            </div>
            <div class="card" id="validatorsList"></div>
        </div>
        <div id="section-analytics" class="page-section" style="display:none">
            <h2>Analytics</h2>
            <div class="market-overview">
                <div class="card">
                    <div class="card-label">TPS</div>
                    <div class="card-value">0.05</div>
                </div>
                <div class="card">
                    <div class="card-label">Avg. Block Time</div>
                    <div class="card-value">60s</div>
                </div>
            </div>
        </div>

        <!-- Details -->
        <div id="section-block" class="page-section" style="display:none">
            <h2 id="blockTitle">Block Detail</h2>
            <div class="card" id="blockDetailContent"></div>
        </div>
        <div id="section-address" class="page-section" style="display:none">
            <h2 id="addressTitle">Address</h2>
            <div class="card" id="addressDetailContent"></div>
        </div>
        <div id="section-tx" class="page-section" style="display:none">
            <h2 id="txTitle">Transaction</h2>
            <div class="card" id="txDetailContent"></div>
        </div>
        <div id="section-search" class="page-section" style="display:none">
            <h2>Search</h2>
            <div class="card">No results found.</div>
        </div>
    </div>

    <div class="status-bar" id="debugLog">Initializing...</div>

    <script>
        // SMART API DETECTION
        // If local file or localhost -> use direct tunnel
        // If Vercel -> use /api proxy
        const API = (location.protocol === 'file:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1')
            ? "http://localhost:5000"
            : "/api";

        let globalChain = [];
        let globalValidators = [];
        let currentPage = 1;
        const PAGE_SIZE = 50;

        function log(msg) {
            const el = document.getElementById('debugLog');
            if (el) el.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
        }

        const navigateTo = url => {
            location.hash = url;
        };

        const router = () => {
            const path = location.hash.slice(1) || "/";
            let view = "home";
            if (path === "/blocks") view = "blocks";
            else if (path === "/transaction") view = "txs";
            else if (path === "/holder") view = "holders";
            else if (path === "/analytics") view = "analytics";
            else if (path === "/validator") view = "validators";
            else if (path.startsWith("/block/")) view = "block";
            else if (path.startsWith("/address/")) view = "address";
            else if (path.startsWith("/tx/")) view = "tx";

            switchTab(view);
            currentPage = 1; // Reset on view change
            if (globalChain.length > 0) renderDetails(path);
        };

        function switchTab(id) {
            document.querySelectorAll('.page-section').forEach(s => s.style.display = 'none');
            const target = document.getElementById(`section-${id}`);
            if (target) target.style.display = 'block';

            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));

            let navId = "nav-home";
            if (id === "blocks") navId = "nav-blocks";
            if (id === "txs") navId = "nav-txs";
            if (id === "holders") navId = "nav-holders";
            if (id === "analytics") navId = "nav-analytics";
            if (id === "validators") navId = "nav-validators";

            const nav = document.getElementById(navId);
            if (nav) nav.classList.add('active');

            if (globalChain.length > 0) render();
        }

        const COIN = 100_000_000;
        // 0x0000FFFF... (from consensus.py)
        const MAX_TARGET = BigInt("0x0000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");

        function formatMoney(amount) {
            const val = amount / COIN;
            return val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 8 }) + " $HOME";
        }

        async function fetchChain() {
            try {
                // log(`Fetching from: ${API}/chain ...`); // Reduce noise
                const res = await fetch(`${API}/chain`);
                if (!res.ok) throw new Error(`HTTP Error ${res.status}`);

                const data = await res.json();
                globalChain = data.chain;
                globalValidators = data.validators || []; // Track full list
                render();

                const path = location.hash.slice(1) || "/";
                renderDetails(path);

                const st = document.getElementById('connStatus');
                if (st) {
                    st.innerText = "OPERATIONAL";
                    st.style.color = "var(--accent)";
                }
            } catch (e) {
                console.error(e);
                const st = document.getElementById('connStatus');
                if (st) {
                    st.innerText = "ERROR: " + e.message;
                    st.style.color = "red";
                }
            }
        }

        function calculateHolders() {
            const balances = {};
            globalChain.forEach(b => {
                b.transactions.forEach(t => {
                    balances[t.sender] = (balances[t.sender] || 0) - t.amount;
                    balances[t.receiver] = (balances[t.receiver] || 0) + t.amount;
                });
                b.rewards.forEach(r => {
                    balances[r.receiver] = (balances[r.receiver] || 0) + r.amount;
                });
            });
            return Object.keys(balances)
                .map(k => ({ address: k, balance: balances[k] }))
                .filter(x => x.balance > 0)
                .sort((a, b) => b.balance - a.balance);
        }

        function render() {
            const holders = calculateHolders();
            const supply = holders.reduce((a, b) => a + b.balance, 0);

            // Stats
            document.getElementById('statHeight').innerText = globalChain.length;

            let difficulty = "---";
            if (globalChain.length > 0) {
                const target = BigInt(globalChain[globalChain.length - 1].target);
                // Difficulty = MAX_TARGET / target
                const diffVal = MAX_TARGET / target;
                difficulty = diffVal.toLocaleString();
            }

            document.getElementById('statDiff').innerText = difficulty;
            document.getElementById('statSupply').innerText = formatMoney(supply);
            document.getElementById('statHolders').innerText = holders.length;

            // Lists
            renderList('blocksListSummary', 7, b => `
                <div class="table-row">
                    <div class="row-data">
                        <span class="row-primary" onclick="navigateTo('/block/${b.index}')">#${b.index}</span>
                        <span class="row-secondary">${timeAgo(b.timestamp)}</span>
                    </div>
                    <div class="row-meta">
                         <span class="badge-pill">${b.transactions.length + (b.rewards ? b.rewards.length : 0)} Txs</span>
                    </div>
                </div>
            `, [...globalChain].reverse());

            const allTx = [];
            [...globalChain].reverse().forEach(b => {
                b.transactions.forEach(t => allTx.push({ ...t, type: 'TX', block: b.index }));
                b.rewards.forEach(r => allTx.push({ ...r, type: 'REW', block: b.index }));
            });

            renderList('txListSummary', 8, t => `
                <div class="table-row">
                    <div class="row-data">
                         <span class="row-primary" onclick="navigateTo('/tx/${t.timestamp}')">${t.type}</span>
                         <span class="row-secondary">${timeAgo(t.timestamp)}</span>
                    </div>
                    <div class="row-meta">
                        <span class="row-primary">${formatMoney(t.amount)}</span>
                         <div style="font-size:0.8em; color:#666">${t.sender.slice(0, 4)}... -> ${t.receiver.slice(0, 4)}...</div>
                    </div>
                </div>
            `, allTx);


            // Full Lists (if visible)
            renderTable('blocksListFull', ['Block', 'Age', 'Txn', 'Validator', 'Reward'], [...globalChain].reverse(), b => `
                <td><span class="hash" onclick="navigateTo('/block/${b.index}')">#${b.index}</span></td>
                <td>${timeAgo(b.timestamp)}</td>
                <td>${b.transactions.length + (b.rewards ? b.rewards.length : 0)}</td>
                <td><span class="addr" onclick="navigateTo('/address/${b.validator}')">${b.validator.slice(0, 10)}...</span></td>
                <td>${formatMoney(b.rewards ? b.rewards.reduce((s, r) => s + r.amount, 0) : 0)}</td>
            `, 'blocksPagination');

            renderTable('holdersList', ['Rank', 'Address', 'Balance', 'Percentage'], holders.map((h, i) => ({ ...h, rank: i + 1 })), h => `
                <td>${h.rank}</td>
                <td><span class="addr" onclick="navigateTo('/address/${h.address}')">${h.address}</span></td>
                <td>${formatMoney(h.balance)}</td>
                <td>${(h.balance / supply * 100).toFixed(4)}%</td>
            `, 'holdersPagination');

            renderTable('txListFull', ['Tx Hash', 'Method', 'Block', 'Age', 'From', 'To', 'Value'], allTx, t => `
                <td><span class="hash" onclick="navigateTo('/tx/${t.timestamp}')">${t.timestamp}</span></td>
                <td><span class="badge">${t.type}</span></td>
                <td><span class="addr" onclick="navigateTo('/block/${t.block}')">#${t.block}</span></td>
                <td>${timeAgo(t.timestamp)}</td>
                <td><span class="addr" onclick="navigateTo('/address/${t.sender}')">${t.sender.slice(0, 8)}...</span></td>
                <td><span class="addr" onclick="navigateTo('/address/${t.receiver}')">${t.receiver.slice(0, 8)}...</span></td>
                <td>${formatMoney(t.amount)}</td>
            `, 'txsPagination');

            // Validators (Full list from API + mined counts)
            const minedCounts = {};
            globalChain.forEach(b => {
                minedCounts[b.validator] = (minedCounts[b.validator] || 0) + 1;
            });

            const validatorList = Array.from(new Set([...globalValidators, ...Object.keys(minedCounts)])).map(addr => ({
                address: addr,
                blocks: minedCounts[addr] || 0,
                status: 'ACTIVE'
            })).sort((a, b) => b.blocks - a.blocks);

            renderTable('validatorsList', ['Rank', 'Validator', 'Blocks Mined', 'Status'], validatorList.map((v, i) => ({ ...v, rank: i + 1 })), v => `
                <td>${v.rank}</td>
                <td><span class="addr" onclick="navigateTo('/address/${v.address}')">${v.address}</span></td>
                <td>${v.blocks}</td>
                <td><span class="badge" style="background:rgba(0,255,0,0.1); color:#00ff00">${v.status}</span></td>
            `, 'validatorsPagination');
        }

        function renderDetails(path) {
            const holders = calculateHolders();

            if (path.startsWith("/block/")) {
                const b = globalChain.find(x => x.index == path.split("/")[2]);
                if (b) {
                    let html = `<div style="padding:20px">
                        <p><strong>Hash:</strong> ${b.hash}</p>
                        <p><strong>Validator:</strong> <a href="#/address/${b.validator}" style="color:var(--accent)">${b.validator}</a></p>
                        <p><strong>Time:</strong> ${new Date(b.timestamp * 1000).toLocaleString()}</p>
                        <h4>Transactions</h4><ul>`;
                    b.transactions.forEach(t => html += `<li><a href="#/address/${t.sender}" style="color:white">${t.sender}</a> -> <a href="#/address/${t.receiver}" style="color:white">${t.receiver}</a>: ${formatMoney(t.amount)}</li>`);
                    html += `</ul><h4>Reward Distributions</h4><ul>`;
                    b.rewards.forEach(r => html += `<li>${r.data?.type || 'Reward'} to <a href="#/address/${r.receiver}" style="color:white">${r.receiver}</a>: ${formatMoney(r.amount)}</li>`);
                    html += `</ul></div>`;
                    document.getElementById('blockDetailContent').innerHTML = html;
                    const title = document.getElementById('blockTitle');
                    if (title) title.innerText = "Block #" + b.index;
                }
            }
            if (path.startsWith("/address/")) {
                const addr = path.split("/")[2];
                const bal = holders.find(x => x.address === addr)?.balance || 0;
                document.getElementById('addressDetailContent').innerHTML = `<div style="padding:20px"><h3>Balance: ${formatMoney(bal)}</h3><p>Address: ${addr}</p></div>`;
                const title = document.getElementById('addressTitle');
                if (title) title.innerText = "Address Detail";
            }
            if (path.startsWith("/tx/")) {
                const ts = path.split("/")[2];
                let found = null;
                for (let b of globalChain) {
                    let t = b.transactions.find(x => x.timestamp == ts);
                    if (!t && b.rewards) t = b.rewards.find(x => x.timestamp == ts);
                    if (t) { found = t; break; }
                }

                if (found) {
                    document.getElementById('txDetailContent').innerHTML = `<div style="padding:20px">
                        <h3>Amount: ${formatMoney(found.amount)}</h3>
                        <p>From: <a href="#/address/${found.sender}" style="color:var(--accent)">${found.sender}</a></p>
                        <p>To: <a href="#/address/${found.receiver}" style="color:var(--accent)">${found.receiver}</a></p>
                        <p>Type: ${found.data?.type || 'Transfer'}</p>
                        <p>Data: ${found.data ? JSON.stringify(found.data) : '-'}</p>
                    </div>`;
                }
            }
        }

        function renderList(id, limit, template, data) {
            const el = document.getElementById(id);
            if (el) el.innerHTML = data.slice(0, limit).map(template).join('');
        }

        function renderTable(id, headers, data, rowTemplate, paginationId) {
            const el = document.getElementById(id);
            if (!el) return;

            const totalPages = Math.ceil(data.length / PAGE_SIZE);
            const start = (currentPage - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const pagedData = data.slice(start, end);

            let html = `<table><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
            html += pagedData.map(d => `<tr>${rowTemplate(d)}</tr>`).join('');
            html += `</tbody></table>`;
            el.innerHTML = html;

            if (paginationId) {
                renderPagination(paginationId, totalPages);
            }
        }

        function renderPagination(id, total) {
            const el = document.getElementById(id);
            if (!el) return;
            if (total <= 1) { el.innerHTML = ''; return; }

            el.innerHTML = `
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
                    <button onclick="changePage(-1)" ${currentPage === 1 ? 'disabled' : ''} class="badge-pill" style="cursor:pointer; border:none; background:var(--bg-card); color:white">PREV</button>
                    <span>Page ${currentPage} of ${total}</span>
                    <button onclick="changePage(1)" ${currentPage === total ? 'disabled' : ''} class="badge-pill" style="cursor:pointer; border:none; background:var(--bg-card); color:white">NEXT</button>
                </div>
            `;
        }

        function changePage(dir) {
            currentPage += dir;
            render();
        }

        function timeAgo(ts) {
            const s = Math.floor(Date.now() / 1000 - ts);
            if (s < 60) return s + 's ago';
            return Math.floor(s / 60) + 'm ago';
        }

        window.addEventListener('hashchange', router);
        window.addEventListener('load', router);
        // document.body.onclick = e => { if (e.target.matches("[data-link]")) { e.preventDefault(); navigateTo(e.target.href); } };
        document.getElementById('globalSearch').onkeypress = e => { if (e.key === 'Enter') { const q = e.target.value; if (/^\d+$/.test(q)) navigateTo('/block/' + q); else navigateTo('/address/' + q); } };

        router(); fetchChain(); setInterval(fetchChain, 10000);
    </script>
</body>

</html>