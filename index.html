<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HomeChain Explorer | Solscan Style</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #121212;
            --bg-card: #1c1c1c;
            --bg-header: #181818;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --accent: #00ffd5;
            --border: #2c2c2c;
            --hover: #2a2a2a;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: 'Roboto', sans-serif;
            margin: 0;
            font-size: 14px;
        }

        .navbar {
            background-color: var(--bg-header);
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            cursor: pointer;
        }

        .search-bar {
            flex: 1;
            max-width: 450px;
            margin: 0 20px;
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input-group {
            width: 100%;
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            width: 100%;
            background: #252525;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 40px 10px 16px;
            color: white;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            border-color: var(--accent);
            outline: none;
        }

        .search-btns {
            position: absolute;
            right: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-btn-icon {
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 16px;
            transition: color 0.2s;
            background: none;
            border: none;
            padding: 4px;
        }

        .search-btn-icon:hover {
            color: var(--accent);
        }

        #clearSearch {
            display: none;
            font-weight: bold;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            margin: 0 24px;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
            font-size: 13px;
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--accent);
        }

        .container {
            max-width: 1200px;
            margin: 24px auto;
            padding: 0 24px;
        }

        .market-overview {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
        }

        .card-label {
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .card-value {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .split-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .section-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 16px;
            font-weight: 500;
        }

        .view-all {
            color: var(--accent);
            font-size: 12px;
            text-decoration: none;
            cursor: pointer;
        }

        .table-row {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
        }

        .table-row:hover {
            background: var(--hover);
        }

        .row-icon {
            width: 40px;
            height: 40px;
            background: #2a2a2a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            color: var(--text-secondary);
        }

        .row-data {
            flex: 1;
        }

        .row-primary {
            display: block;
            color: var(--accent);
            margin-bottom: 4px;
            cursor: pointer;
        }

        .row-secondary {
            display: block;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .row-meta {
            text-align: right;
        }

        .badge-pill {
            background: rgba(0, 255, 213, 0.1);
            color: var(--accent);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #252525;
            padding: 8px 24px;
            font-size: 12px;
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            z-index: 1000;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }

        th {
            text-align: left;
            padding: 12px;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.02);
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        td .addr {
            font-family: monospace;
            color: var(--accent);
            cursor: pointer;
        }

        td .hash {
            font-family: monospace;
            color: white;
            cursor: pointer;
        }

        td .badge {
            background: rgba(0, 243, 255, 0.1);
            color: var(--accent);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .row-data,
        .row-meta {
            display: flex;
            flex-direction: column;
        }

        .copy-btn {
            cursor: pointer;
            margin-left: 6px;
            opacity: 0.6;
            transition: opacity 0.2s;
            font-size: 14px;
            user-select: none;
        }

        .copy-btn:hover {
            opacity: 1;
            color: var(--accent);
        }

        .addr-wrapper {
            display: inline-flex;
            align-items: center;
            font-family: monospace;
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 0 12px;
                flex-wrap: wrap;
                height: auto;
                min-height: 64px;
                padding-bottom: 10px;
                gap: 10px;
            }

            .brand span {
                display: none;
            }

            .nav-links {
                overflow-x: auto;
                margin: 0;
                width: 100%;
                justify-content: start;
                gap: 15px;
            }

            .search-bar {
                max-width: 100%;
                margin: 0;
                order: 3;
                width: 100%;
            }

            .market-overview {
                grid-template-columns: 1fr 1fr;
            }

            .split-view {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 0 12px;
                margin-top: 12px;
            }

            th:nth-child(n+3),
            td:nth-child(n+3) {
                display: none;
            }

            th.mobile-show,
            td.mobile-show {
                display: table-cell !important;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="brand" onclick="navigateTo('/')">
            <img src="logo_final.png" alt="HomeChain" style="height: 38px; border-radius: 8px;">
            <span>HomeChainScan</span>
        </div>
        <div class="nav-links">
            <a href="#/" class="nav-link active" data-link id="nav-home">Home</a>
            <a href="#/blocks" class="nav-link" data-link id="nav-blocks">Blocks</a>
            <a href="#/transaction" class="nav-link" data-link id="nav-txs">TXs</a>
            <a href="#/rewards" class="nav-link" data-link id="nav-rewards">Rewards</a>
            <a href="#/holder" class="nav-link" data-link id="nav-holders">Holders</a>
            <a href="#/analytics" class="nav-link" data-link id="nav-analytics">Analytics</a>
            <a href="#/validator" class="nav-link" data-link id="nav-validators">Validators</a>
        </div>
        <div class="search-bar">
            <div class="search-input-group">
                <input type="text" id="globalSearch" class="search-input" placeholder="Search by Block, Hash, Address">
                <div class="search-btns">
                    <button id="clearSearch" class="search-btn-icon" title="Clear">‚úï</button>
                    <button id="execSearch" class="search-btn-icon" title="Search">üîç</button>
                </div>
            </div>
        </div>
        <div class="status-indicator">
            <div id="connStatus" class="badge-pill">
                <span>CONNECTING...</span>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Home -->
        <div id="section-home" class="page-section">
            <div class="market-overview">
                <div class="card">
                    <div class="card-label">Block Height</div>
                    <div class="card-value" id="statHeight">---</div>
                </div>
                <div class="card">
                    <div class="card-label">Network Difficulty</div>
                    <div class="card-value" id="statDiff">---</div>
                </div>
                <div class="card">
                    <div class="card-label">Total Supply</div>
                    <div class="card-value" id="statSupply">---</div>
                </div>
                <div class="card">
                    <div class="card-label">Total Holders</div>
                    <div class="card-value" id="statHolders">---</div>
                </div>
            </div>
            <div class="split-view">
                <div class="card" style="padding:0">
                    <div class="section-header">
                        <div class="section-title">Latest Blocks</div><a class="view-all" href="#/blocks" data-link>View
                            All</a>
                    </div>
                    <div id="blocksListSummary"></div>
                </div>
                <div class="card" style="padding:0">
                    <div class="section-header">
                        <div class="section-title">Recent Activity</div><a class="view-all" href="#/transaction"
                            data-link>View All</a>
                    </div>
                    <div id="txListSummary"></div>
                </div>
            </div>
            <div class="card" style="padding:0; margin-top: 24px;">
                <div class="section-header">
                    <div class="section-title">Latest Rewards (Coinbase)</div><a class="view-all" href="#/rewards"
                        data-link>View All</a>
                </div>
                <div id="rewardsListSummary"></div>
            </div>
        </div>

        <!-- Sections -->
        <div id="section-blocks" class="page-section" style="display:none">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h2>Blocks</h2>
                <div id="blocksPagination" class="pagination-controls"></div>
            </div>
            <div class="card" id="blocksListFull"></div>
        </div>
        <div id="section-txs" class="page-section" style="display:none">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h2>Transactions</h2>
                <div id="txsPagination" class="pagination-controls"></div>
            </div>
            <div class="card" id="txListFull"></div>
        </div>

        <div id="section-rewards" class="page-section" style="display:none">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h2>Reward Distributions</h2>
                <div id="rewardsPagination" class="pagination-controls"></div>
            </div>
            <div class="card" id="rewardsListFull"></div>
        </div>
        <div id="section-holders" class="page-section" style="display:none">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h2>Top Holders</h2>
                <div id="holdersPagination" class="pagination-controls"></div>
            </div>
            <div class="card" id="holdersList"></div>
        </div>
        <div id="section-validators" class="page-section" style="display:none">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h2>Validators</h2>
                <div id="validatorsPagination" class="pagination-controls"></div>
            </div>
            <div class="card" id="validatorsList"></div>
        </div>
        <div id="section-analytics" class="page-section" style="display:none">
            <h2>Analytics</h2>
            <div class="market-overview">
                <div class="card">
                    <div class="card-label">TPS</div>
                    <div class="card-value">0.05</div>
                </div>
                <div class="card">
                    <div class="card-label">Avg. Block Time</div>
                    <div class="card-value">60s</div>
                </div>
            </div>
        </div>

        <!-- Details -->
        <div id="section-block" class="page-section" style="display:none">
            <h2 id="blockTitle">Block Detail</h2>
            <div class="card" id="blockDetailContent"></div>
        </div>
        <div id="section-address" class="page-section" style="display:none">
            <h2 id="addressTitle">Address</h2>
            <div class="card" id="addressDetailContent"></div>
        </div>
        <div id="section-tx" class="page-section" style="display:none">
            <h2 id="txTitle">Transaction</h2>
            <div class="card" id="txDetailContent"></div>
        </div>
        <div id="section-search" class="page-section" style="display:none">
            <h2>Search</h2>
            <div class="card">No results found.</div>
        </div>
    </div>

    <div class="status-bar" id="debugLog">Initializing...</div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // SUPABASE CONFIGURATION
        const SB_URL = "https://qmlcekoypbutzsliqqkm.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtbGNla295cGJ1dHpzbGlxcWttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNTk5ODAsImV4cCI6MjA4NTgzNTk4MH0.OD8T1wYGiSU2KEQD435lWiU5b38KHQjdSq94_P3Au5c";

        // Use a different name to avoid collision with the 'supabase' library object
        const sbClient = supabase.createClient(SB_URL, SB_KEY);

        let globalStats = { height: 0, difficulty: "---", supply: 0, holders: 0 };
        let currentPage = 1;
        const PAGE_SIZE = 50;

        function log(msg) {
            const el = document.getElementById('debugLog');
            if (el) el.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
        }

        function formatDisplay(str, type = 'address') {
            if (!str) return '---';
            const short = str.length > 12 ? str.slice(0, 6) + '...' + str.slice(-4) : str;
            const clickPath = type === 'block' ? `/block/${str}` : (type === 'tx' ? `/tx/${str}` : `/address/${str}`);
            return `
                <div class="addr-wrapper">
                    <span class="addr" onclick="navigateTo('${clickPath}')">${short}</span>
                    <span class="copy-btn" onclick="copyToClipboard('${str}')" title="Copy Full Content">üìã</span>
                </div>
            `;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const el = document.getElementById('debugLog');
                const old = el.innerText;
                el.innerText = "COPIED TO CLIPBOARD!";
                el.style.color = "var(--accent)";
                setTimeout(() => {
                    el.innerText = old;
                    el.style.color = "var(--text-secondary)";
                }, 2000);
            });
        }

        const navigateTo = url => {
            location.hash = url;
            router();
        };

        let currentView = "";
        const router = () => {
            const path = location.hash.slice(1) || "/";
            let view = "home";
            if (path === "/blocks") view = "blocks";
            else if (path === "/transaction") view = "txs";
            else if (path === "/holder") view = "holders";
            else if (path === "/analytics") view = "analytics";
            else if (path === "/validator") view = "validators";
            else if (path === "/rewards") view = "rewards";
            else if (path.startsWith("/block/")) view = "block";
            else if (path.startsWith("/address/")) view = "address";
            else if (path.startsWith("/tx/")) view = "tx";

            switchTab(view);

            // PAGINATION FIX: Only reset page if switching to a new main tab
            if (view !== currentView && !["block", "address", "tx"].includes(view)) {
                currentPage = 1;
            }
            currentView = view;

            updateView(view, path);
        };

        function switchTab(id) {
            document.querySelectorAll('.page-section').forEach(s => s.style.display = 'none');
            const target = document.getElementById(`section-${id}`);
            if (target) target.style.display = 'block';

            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const navIdMap = {
                "home": "nav-home", "blocks": "nav-blocks", "txs": "nav-txs", "rewards": "nav-rewards",
                "holders": "nav-holders", "analytics": "nav-analytics", "validators": "nav-validators"
            };
            const nav = document.getElementById(navIdMap[id] || "nav-home");
            if (nav) nav.classList.add('active');
        }

        const COIN = 100_000_000;
        const MAX_TARGET = BigInt("0x0000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");

        function formatMoney(amount) {
            const val = Number(amount) / COIN;
            return val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 8 }) + " $HOME";
        }

        async function fetchStats() {
            try {
                const { data, error } = await sbClient.from('stats').select('*').eq('id', 1).single();
                if (error) throw error;

                globalStats = {
                    height: data.height,
                    difficulty: data.difficulty,
                    supply: data.total_supply,
                    holders: 0 // Will fetch count
                };

                const { count } = await sbClient.from('holders').select('*', { count: 'exact', head: true });
                globalStats.holders = count || 0;

                renderStats();
            } catch (e) {
                log("Stats error: " + e.message);
            }
        }

        function renderStats() {
            document.getElementById('statHeight').innerText = globalStats.height;
            let diffStr = "---";
            if (globalStats.difficulty && globalStats.difficulty !== "---") {
                const target = BigInt(globalStats.difficulty);
                diffStr = (MAX_TARGET / target).toLocaleString();
            }
            document.getElementById('statDiff').innerText = diffStr;
            document.getElementById('statSupply').innerText = formatMoney(globalStats.supply);
            document.getElementById('statHolders').innerText = globalStats.holders;
        }

        async function updateView(view, path) {
            log(`Loading ${view}...`);
            const connStatus = document.getElementById('connStatus');
            connStatus.innerText = "LOADING...";
            connStatus.style.color = "orange";

            // Always ensure stats are fresh before rendering dependent views
            await fetchStats();

            if (view === "home") {
                await Promise.all([fetchLatestBlocks(), fetchLatestTxs(), fetchLatestRewards()]);
            } else if (view === "blocks") {
                await fetchBlocks();
            } else if (view === "txs") {
                await fetchTxs();
            } else if (view === "rewards") {
                await fetchRewards();
            } else if (view === "holders") {
                await fetchHolders();
            } else if (view === "validators") {
                await fetchValidators();
            } else if (view === "block") {
                await fetchBlockDetail(path.split("/")[2]);
            } else if (view === "address") {
                await fetchAddressDetail(path.split("/")[2]);
            } else if (view === "tx") {
                await fetchTxDetail(path.split("/")[2]);
            }

            connStatus.innerText = "OPERATIONAL";
            connStatus.style.color = "var(--accent)";
        }

        async function fetchLatestBlocks() {
            try {
                const { data } = await sbClient.from('blocks').select('*').order('id', { ascending: false }).limit(7);
                if (!data || data.length === 0) {
                    document.getElementById('blocksListSummary').innerHTML = '<div class="card">No blocks found.</div>';
                    return;
                }
                const html = data.map(b => `
                    <div class="table-row">
                        <div class="row-data">
                            <span class="row-primary" onclick="navigateTo('/block/${b.id}')">#${b.id}</span>
                            <span class="row-secondary">${timeAgo(new Date(b.timestamp).getTime() / 1000)}</span>
                        </div>
                        <div class="row-meta">
                            <span class="badge-pill">${(b.tx_count || 0) + (b.reward_count || 0)} Txs</span>
                        </div>
                    </div>
                `).join('');
                document.getElementById('blocksListSummary').innerHTML = html;
            } catch (e) { log("Latest blocks error: " + e.message); }
        }

        async function fetchLatestTxs() {
            try {
                const { data: txs } = await sbClient.from('transactions').select('*').order('id', { ascending: false }).limit(8);

                if (!txs || txs.length === 0) {
                    document.getElementById('txListSummary').innerHTML = '<div class="card">No transactions found.</div>';
                    return;
                }

                const html = txs.map(t => `
                    <div class="table-row">
                        <div class="row-data">
                            <span class="row-primary" onclick="navigateTo('/tx/${t.signature || t.id}')">TRANSFER</span>
                            <span class="row-secondary">${timeAgo(new Date(t.timestamp).getTime() / 1000)}</span>
                        </div>
                        <div class="row-meta">
                            <span class="row-primary">${formatMoney(t.amount || 0)}</span>
                            <div style="font-size:0.85em; font-family:monospace; color:var(--text-secondary)">
                                ${formatDisplay(t.sender)} ‚Üí ${formatDisplay(t.receiver)}
                            </div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('txListSummary').innerHTML = html;
            } catch (e) { log("Latest txs error: " + e.message); }
        }

        async function fetchBlocks() {
            const start = (currentPage - 1) * PAGE_SIZE;
            const { data, count } = await sbClient.from('blocks').select('*', { count: 'exact' })
                .order('id', { ascending: false }).range(start, start + PAGE_SIZE - 1);

            const totalPages = Math.ceil(count / PAGE_SIZE);
            const headers = ['Block', 'Age', 'Txn', 'Validator', 'Reward Count'];
            const html = `<table><thead><tr>
                <th class="mobile-show">Block</th>
                <th class="mobile-show">Age</th>
                <th>Txn</th>
                <th>Validator</th>
                <th>Reward Count</th>
            </tr></thead><tbody>` +
                data.map(b => `<tr>
                    <td class="mobile-show"><span class="hash" onclick="navigateTo('/block/${b.id}')">#${b.id}</span></td>
                    <td class="mobile-show">${timeAgo(new Date(b.timestamp).getTime() / 1000)}</td>
                    <td>${b.tx_count + b.reward_count}</td>
                    <td>${formatDisplay(b.validator)}</td>
                    <td>${b.reward_count} distributions</td>
                </tr>`).join('') + `</tbody></table>`;

            document.getElementById('blocksListFull').innerHTML = html;
            renderPagination('blocksPagination', totalPages);
        }

        async function fetchTxs() {
            const start = (currentPage - 1) * PAGE_SIZE;

            const { data: txs, count } = await sbClient.from('transactions').select('*', { count: 'exact' })
                .order('id', { ascending: false }).range(start, start + PAGE_SIZE - 1);

            if (!txs || txs.length === 0) {
                document.getElementById('txListFull').innerHTML = '<div class="card">No transactions found.</div>';
                return;
            }

            const totalPages = Math.ceil(count / PAGE_SIZE);
            const html = `<table><thead><tr>
                <th class="mobile-show">Signature</th>
                <th class="mobile-show">Age</th>
                <th>From</th>
                <th>To</th>
                <th>Amount</th>
            </tr></thead><tbody>` +
                txs.map(t => `<tr>
                    <td class="mobile-show">${formatDisplay(t.signature || t.id.toString(), 'tx')}</td>
                    <td class="mobile-show">${timeAgo(new Date(t.timestamp).getTime() / 1000)}</td>
                    <td>${formatDisplay(t.sender)}</td>
                    <td>${formatDisplay(t.receiver)}</td>
                    <td><span class="badge">${formatMoney(t.amount)}</span></td>
                </tr>`).join('') + `</tbody></table>`;

            document.getElementById('txListFull').innerHTML = html;
            renderPagination('txsPagination', totalPages);
        }

        async function fetchLatestRewards() {
            try {
                const { data, error } = await sbClient.from('rewards').select('*').order('timestamp', { ascending: false }).limit(6);
                if (error) throw error;
                const html = data.map(r => `
                    <div class="table-row">
                        <div class="row-data">
                            <span class="row-primary">${r.type} Distribution</span>
                            <span class="row-secondary">${timeAgo(new Date(r.timestamp).getTime() / 1000)}</span>
                        </div>
                        <div class="row-meta">
                            <span class="badge-pill">${formatMoney(r.amount)}</span>
                            <span class="row-secondary">to ${formatDisplay(r.receiver)}</span>
                        </div>
                    </div>
                `).join('');
                document.getElementById('rewardsListSummary').innerHTML = html;
            } catch (e) { log("Latest rewards error: " + e.message); }
        }

        async function fetchRewards() {
            const start = (currentPage - 1) * PAGE_SIZE;
            const { data, count, error } = await sbClient.from('rewards').select('*', { count: 'exact' })
                .order('timestamp', { ascending: false }).range(start, start + PAGE_SIZE - 1);

            if (error) {
                log("Fetch rewards error: " + error.message);
                return;
            }

            const totalPages = Math.ceil(count / PAGE_SIZE);
            const html = `<table><thead><tr>
                <th class="mobile-show">Block</th>
                <th class="mobile-show">Age</th>
                <th>Recipient</th>
                <th>Type</th>
                <th>Value</th>
            </tr></thead><tbody>` +
                data.map(r => `<tr>
                    <td class="mobile-show"><span class="hash" onclick="navigateTo('/block/${r.block_id}')">#${r.block_id}</span></td>
                    <td class="mobile-show">${timeAgo(new Date(r.timestamp).getTime() / 1000)}</td>
                    <td>${formatDisplay(r.receiver)}</td>
                    <td><span class="badge">${r.type}</span></td>
                    <td>${formatMoney(r.amount)}</td>
                </tr>`).join('') + `</tbody></table>`;

            if (document.getElementById('rewardsListFull')) {
                document.getElementById('rewardsListFull').innerHTML = html;
                renderPagination('rewardsPagination', totalPages);
            }
        }

        async function fetchHolders() {
            const start = (currentPage - 1) * PAGE_SIZE;
            const { data, count } = await sbClient.from('holders').select('*', { count: 'exact' })
                .order('balance', { ascending: false }).range(start, start + PAGE_SIZE - 1);

            const totalPages = Math.ceil(count / PAGE_SIZE);
            const html = `<table><thead><tr>
                <th class="mobile-show">Rank</th>
                <th class="mobile-show">Address</th>
                <th class="mobile-show">Balance</th>
                <th>Percentage</th>
            </tr></thead><tbody>` +
                data.map((h, i) => {
                    const pct = globalStats.supply > 0 ? ((h.balance / globalStats.supply) * 100).toFixed(4) : "0.0000";
                    return `<tr>
                        <td class="mobile-show">${start + i + 1}</td>
                        <td class="mobile-show">${formatDisplay(h.address)}</td>
                        <td class="mobile-show">${formatMoney(h.balance)}</td>
                        <td>${pct}%</td>
                    </tr>`;
                }).join('') + `</tbody></table>`;

            document.getElementById('holdersList').innerHTML = html;
            renderPagination('holdersPagination', totalPages);
        }

        async function fetchValidators() {
            const { data } = await sbClient.from('blocks').select('validator');
            const counts = {};
            data.forEach(x => counts[x.validator] = (counts[x.validator] || 0) + 1);
            const fullList = Object.keys(counts).map(addr => ({ address: addr, blocks: counts[addr] })).sort((a, b) => b.blocks - a.blocks);

            const totalCount = fullList.length;
            const totalPages = Math.ceil(totalCount / PAGE_SIZE);
            const start = (currentPage - 1) * PAGE_SIZE;
            const list = fullList.slice(start, start + PAGE_SIZE);

            const html = `<table><thead><tr>
                <th class="mobile-show">Rank</th>
                <th class="mobile-show">Validator</th>
                <th class="mobile-show">Blocks</th>
                <th>Status</th>
            </tr></thead><tbody>` +
                list.map((v, i) => `<tr>
                    <td class="mobile-show">${start + i + 1}</td>
                    <td class="mobile-show">${formatDisplay(v.address)}</td>
                    <td class="mobile-show">${v.blocks}</td>
                    <td><span class="badge" style="background:rgba(0,255,0,0.1); color:#00ff00">ACTIVE</span></td>
                </tr>`).join('') + `</tbody></table>`;

            document.getElementById('validatorsList').innerHTML = html;
            renderPagination('validatorsPagination', totalPages);
        }

        async function fetchBlockDetail(id) {
            const { data: b } = await sbClient.from('blocks').select('*').eq('id', id).single();
            const { data: txs } = await sbClient.from('transactions').select('*').eq('block_id', id);
            const { data: rews } = await sbClient.from('rewards').select('*').eq('block_id', id);

            let html = `<div style="padding:20px">
                <p><strong>Hash:</strong> ${formatDisplay(b.hash, 'tx')}</p>
                <p><strong>Validator:</strong> ${formatDisplay(b.validator)}</p>
                <p><strong>Time:</strong> ${new Date(b.timestamp).toLocaleString()}</p>
                <hr style="border:0; border-top:1px solid var(--border); margin:20px 0">
                <h4>Transactions (${txs.length})</h4><ul>` +
                txs.map(t => `<li>${formatDisplay(t.sender)} ‚Üí ${formatDisplay(t.receiver)}: <b>${formatMoney(t.amount)}</b></li>`).join('') +
                `</ul><h4 style="margin-top:20px">Rewards (${rews.length})</h4><ul>` +
                rews.map(r => `<li>${r.type} to ${formatDisplay(r.receiver)}: <b>${formatMoney(r.amount)}</b></li>`).join('') +
                `</ul></div>`;

            document.getElementById('blockDetailContent').innerHTML = html;
            document.getElementById('blockTitle').innerText = "Block #" + b.id;
        }

        async function fetchAddressDetail(addr) {
            const { data: h } = await sbClient.from('holders').select('balance').eq('address', addr).single();
            const bal = h ? h.balance : 0;

            // Fetch Transctions (Sent and Received)
            const { data: txsSent } = await sbClient.from('transactions').select('*').eq('sender', addr).order('timestamp', { ascending: false }).limit(20);
            const { data: txsRecv } = await sbClient.from('transactions').select('*').eq('receiver', addr).order('timestamp', { ascending: false }).limit(20);
            const { data: rews } = await sbClient.from('rewards').select('*').eq('receiver', addr).order('timestamp', { ascending: false }).limit(20);

            const combined = [
                ...(txsSent || []).map(t => ({ ...t, type: 'Sent', partner: t.receiver, sign: -1 })),
                ...(txsRecv || []).map(t => ({ ...t, type: 'Received', partner: t.sender, sign: 1 })),
                ...(rews || []).map(r => ({ ...r, type: r.type || 'Reward', partner: 'SYSTEM', sign: 1, signature: r.id }))
            ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 50);

            let html = `
                <div style="padding:20px">
                    <div class="card" style="margin-bottom:20px">
                        <h3 style="color:var(--accent)">Balance: ${formatMoney(bal)}</h3>
                        <p style="font-size:0.9em; opacity:0.8; margin-top:5px">${addr}</p>
                    </div>

                    <h4 style="margin-bottom:15px">Recent Transactions</h4>
                    <div class="card" style="padding:0; overflow:hidden">
                        <table style="width:100%; border-collapse:collapse">
                            <thead>
                                <tr style="background:rgba(255,255,255,0.05)">
                                    <th style="padding:12px; text-align:left">Hash</th>
                                    <th style="padding:12px; text-align:left">Age</th>
                                    <th style="padding:12px; text-align:left">Type</th>
                                    <th style="padding:12px; text-align:left">Partner</th>
                                    <th style="padding:12px; text-align:right">Amount</th>
                                </tr>
                            </thead>
                            <tbody>` +
                combined.map(t => `
                    <tr style="border-top:1px solid var(--border)">
                        <td style="padding:12px">${formatDisplay(t.signature || t.id.toString(), 'tx')}</td>
                        <td style="padding:12px">${timeAgo(new Date(t.timestamp).getTime() / 1000)}</td>
                        <td style="padding:12px"><span class="badge" style="background:${t.type === 'Sent' ? 'rgba(255,0,0,0.1)' : 'rgba(0,255,0,0.1)'}; color:${t.type === 'Sent' ? '#ff4d4d' : '#00ff00'}">${t.type}</span></td>
                        <td style="padding:12px">${formatDisplay(t.partner)}</td>
                        <td style="padding:12px; text-align:right; color:${t.sign > 0 ? '#00ff00' : '#ff4d4d'}">${t.sign > 0 ? '+' : '-'}${formatMoney(t.amount)}</td>
                    </tr>`).join('') + (combined.length === 0 ? '<tr><td colspan="5" style="padding:20px; text-align:center; opacity:0.5">No transactions found</td></tr>' : '') +
                `</tbody></table>
                    </div>
                </div>`;

            document.getElementById('addressDetailContent').innerHTML = html;
            document.getElementById('addressTitle').innerText = "Address Detailed View";
        }

        async function fetchTxDetail(id) {
            let { data: tx } = await sbClient.from('transactions').select('*').or(`signature.eq.${id},id.eq.${id}`).maybeSingle();
            if (!tx) {
                const { data: rew } = await sbClient.from('rewards').select('*').eq('id', id).maybeSingle();
                tx = rew ? { ...rew, sender: 'SYSTEM', type: rew.type } : null;
            }

            if (tx) {
                document.getElementById('txDetailContent').innerHTML = `
                <div style="padding:20px">
                    <h3>Amount: ${formatMoney(tx.amount)}</h3>
                    <p><strong>Hash:</strong> ${formatDisplay(tx.signature || tx.id.toString(), 'tx')}</p>
                    <p><strong>From:</strong> ${formatDisplay(tx.sender || 'SYSTEM')}</p>
                    <p><strong>To:</strong> ${formatDisplay(tx.receiver)}</p>
                    <p><strong>Type:</strong> ${tx.type || 'Transfer'}</p>
                    <p><strong>Block:</strong> <span class="hash" onclick="navigateTo('/block/${tx.block_id}')">#${tx.block_id}</span></p>
                    <p><strong>Time:</strong> ${new Date(tx.timestamp).toLocaleString()}</p>
                </div>`;
            } else {
                document.getElementById('txDetailContent').innerHTML = '<div class="card">Transaction not found.</div>';
            }
        }

        function renderPagination(id, total) {
            const el = document.getElementById(id);
            if (!el || total <= 1) { el.innerHTML = ''; return; }
            el.innerHTML = `
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
                    <button onclick="changePage(-1)" ${currentPage === 1 ? 'disabled' : ''} class="badge-pill" style="cursor:pointer; border:none; background:var(--bg-card); color:white">PREV</button>
                    <span>Page ${currentPage} of ${total}</span>
                    <button onclick="changePage(1)" ${currentPage === total ? 'disabled' : ''} class="badge-pill" style="cursor:pointer; border:none; background:var(--bg-card); color:white">NEXT</button>
                </div>
            `;
        }

        function changePage(dir) {
            currentPage += dir;
            router();
        }

        function timeAgo(ts) {
            const s = Math.floor(Date.now() / 1000 - ts);
            if (s < 60) return s + 's ago';
            if (s < 3600) return Math.floor(s / 60) + 'm ago';
            return Math.floor(s / 3600) + 'h ago';
        }

        window.addEventListener('hashchange', router);
        window.addEventListener('load', () => {
            fetchStats();
            router();

            // 4. REALTIME SUBSCRIPTION
            sbClient.channel('public:stats')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'stats' }, payload => {
                    log("Realtime: Stats updated!");
                    globalStats = {
                        height: payload.new.height,
                        difficulty: payload.new.difficulty,
                        supply: payload.new.total_supply,
                        holders: globalStats.holders // Placeholder
                    };
                    renderStats();
                    if (location.hash === "" || location.hash === "#/") {
                        fetchLatestBlocks();
                        fetchLatestTxs();
                    }
                })
                .subscribe();
        });
        setInterval(fetchStats, 60000); // Less frequent poll as backup

        const searchInput = document.getElementById('globalSearch');
        const clearBtn = document.getElementById('clearSearch');
        const searchBtn = document.getElementById('execSearch');

        const performSearch = () => {
            const q = searchInput.value.trim();
            if (!q) return;
            if (/^\d+$/.test(q)) navigateTo('/block/' + q);
            else if (q.length > 30) navigateTo('/address/' + q);
            else log("Search term not specific enough.");
        };

        searchInput.oninput = e => {
            clearBtn.style.display = e.target.value ? 'block' : 'none';
        };

        searchInput.onkeypress = e => {
            if (e.key === 'Enter') performSearch();
        };

        clearBtn.onclick = () => {
            searchInput.value = '';
            clearBtn.style.display = 'none';
            searchInput.focus();
        };

        searchBtn.onclick = performSearch;
    </script>
</body>

</html>